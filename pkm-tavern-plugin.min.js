(async function(){"use strict";const PLUGIN_NAME="[PKM战斗插件]";const PKM_BATTLE_TAG="PKM_BATTLE";const PKM_INJECT_ID="pkm_player_data";let lastHandledMk=null;let isProcessing=false;console.log(`${PLUGIN_NAME} 插件加载中...`);function wait(ms){return new Promise(resolve=>setTimeout(resolve,ms))}async function getEraVars(){return new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{console.warn(`${PLUGIN_NAME} ERA 查询超时`);resolve(null)},5e3);eventOn("era:queryResult",detail=>{if(detail.queryType==="getCurrentVars"){clearTimeout(timeout);resolve(detail.result?.statWithoutMeta||null)}},{once:true});eventEmit("era:getCurrentVars")})}function isNewFormat(eraVars){if(!eraVars)return true;return!eraVars.pkm&&(eraVars.player||eraVars.world_state||eraVars.settings)}function getCompatPath(eraVars,path){const useNewFormat=isNewFormat(eraVars);if(useNewFormat&&path.startsWith("pkm.")){return path.slice(4)}if(!useNewFormat&&!path.startsWith("pkm.")){return"pkm."+path}return path}function getEraValue(eraVars,path,defaultValue){if(!eraVars)return defaultValue;let value=_.get(eraVars,path);if(value!==undefined)return value;const compatPath=getCompatPath(eraVars,path);if(compatPath!==path){value=_.get(eraVars,compatPath);if(value!==undefined)return value}return defaultValue}function convertUpdatePaths(eraVars,data){const useNewFormat=isNewFormat(eraVars);const converted={};for(const[path,value]of Object.entries(data)){let newPath=path;if(useNewFormat&&path.startsWith("pkm.")){newPath=path.slice(4)}else if(!useNewFormat&&!path.startsWith("pkm.")){newPath="pkm."+path}converted[newPath]=value}return converted}async function updateEraVars(data){return new Promise(async resolve=>{const currentVars=await getEraVars();const convertedData=convertUpdatePaths(currentVars,data);const nestedData={};for(const[path,value]of Object.entries(convertedData)){const parts=path.split(".");let current=nestedData;if(path.includes("stats_meta")&&typeof value==="object"&&value.ev_level!==undefined){const currentEvLevel=_.get(currentVars,`${path}.ev_level`,0);const newEvLevel=value.ev_level;console.log(`${PLUGIN_NAME} [EV_LEVEL] 路径: ${path}, 当前: ${currentEvLevel}, AI输出: ${newEvLevel}`);if(newEvLevel<currentEvLevel){value.ev_level=currentEvLevel+newEvLevel;console.log(`${PLUGIN_NAME} [EV_LEVEL] 检测到小值，累加模式: ${currentEvLevel} + ${newEvLevel} = ${value.ev_level}`)}else{console.log(`${PLUGIN_NAME} [EV_LEVEL] 检测到大值，替换模式: ${currentEvLevel} -> ${newEvLevel}`)}}for(let i=0;i<parts.length-1;i++){const part=parts[i];if(!current[part]){current[part]={}}current=current[part]}current[parts[parts.length-1]]=value}console.log(`${PLUGIN_NAME} [DEBUG] 准备更新 ERA 变量:`,JSON.stringify(nestedData,null,2));eventEmit("era:updateByObject",nestedData);setTimeout(()=>{console.log(`${PLUGIN_NAME} [DEBUG] ERA 变量更新已发送`);resolve()},100)})}function insertEraVars(data){eventEmit("era:insertByObject",data)}async function getPlayerParty(){const eraVars=await getEraVars();if(!eraVars)return null;const playerData=getEraValue(eraVars,"player",null);return playerData}function createEmptySlot(slotNum){return{slot:slotNum,name:null,nickname:null,species:null,gender:null,lv:null,quality:null,nature:null,ability:null,shiny:false,item:null,moves:{move1:null,move2:null,move3:null,move4:null},stats_meta:{ivs:{hp:null,atk:null,def:null,spa:null,spd:null,spe:null},ev_level:null},notes:null}}function getAllPokemon(playerData){const partyPokemon=parsePartyData(playerData?.party);const reservePokemon=parsePartyData(playerData?.reserve);return[...partyPokemon,...reservePokemon]}async function setPlayerParty(mode,input=null){console.warn(`${PLUGIN_NAME} setPlayerParty 已弃用，请使用 VariableEdit 直接更新槽位`);const eraVars=await getEraVars();const playerData=getEraValue(eraVars,"player",{name:"训练家",party:{slot1:createEmptySlot(1),slot2:createEmptySlot(2),slot3:createEmptySlot(3),slot4:createEmptySlot(4),slot5:createEmptySlot(5),slot6:createEmptySlot(6)},reserve:{}});const allPokemon=getAllPokemon(playerData);switch(mode){case"single":if(typeof input==="string"){const found=allPokemon.find(p=>p.name?.toLowerCase()===input.toLowerCase()||p.nickname?.toLowerCase()===input.toLowerCase());if(found){updateEraVars({"player.party.slot1":found});console.log(`${PLUGIN_NAME} ✓ 已将 ${found.name} 设置到 slot1`);return found}else{console.warn(`${PLUGIN_NAME} 未找到宝可梦: ${input}`);return null}}break;default:console.warn(`${PLUGIN_NAME} 模式 ${mode} 不再支持，请使用 VariableEdit`);return null}return null}function stripJsonComments(jsonStr){let result="";let i=0;let inString=false;let stringChar=null;while(i<jsonStr.length){const char=jsonStr[i];const nextChar=jsonStr[i+1];if(!inString&&(char==='"'||char==="'")){inString=true;stringChar=char;result+=char;i++;continue}if(inString){result+=char;if(char==="\\"&&nextChar){result+=nextChar;i+=2;continue}if(char===stringChar){inString=false;stringChar=null}i++;continue}if(char==="/"&&nextChar==="/"){i+=2;while(i<jsonStr.length&&jsonStr[i]!=="\n"&&jsonStr[i]!=="\r"){i++}continue}if(char==="/"&&nextChar==="*"){i+=2;while(i<jsonStr.length-1){if(jsonStr[i]==="*"&&jsonStr[i+1]==="/"){i+=2;break}i++}continue}result+=char;i++}return result}function extractJsonCandidate(rawText){if(!rawText)return null;const trimmed=rawText.trim();if(!trimmed)return null;if(trimmed.startsWith("{")||trimmed.startsWith("[")){const closingChar=trimmed.startsWith("{")?"}":"]";const endIndex=trimmed.lastIndexOf(closingChar);if(endIndex!==-1){return trimmed.slice(0,endIndex+1)}return trimmed}const braceIndex=trimmed.indexOf("{");let startIndex=-1;let closingChar=null;if(braceIndex!==-1){startIndex=braceIndex;closingChar="}"}else{const bracketIndex=trimmed.indexOf("[");if(bracketIndex!==-1){startIndex=bracketIndex;closingChar="]"}}if(startIndex===-1){return null}const sliced=trimmed.slice(startIndex);const endIndex=closingChar?sliced.lastIndexOf(closingChar):-1;if(endIndex!==-1){return sliced.slice(0,endIndex+1)}return sliced}function parseAiBattleOutput(messageText){let cleanedText=messageText;cleanedText=cleanedText.replace(/[\s\S]*<\/planning>/gi,"");cleanedText=cleanedText.replace(/[\s\S]*<\/think>/gi,"");const regex=new RegExp(`<${PKM_BATTLE_TAG}>([\\s\\S]*?)<\\/${PKM_BATTLE_TAG}>`,"gi");let match=null;let latestMatch=null;while((match=regex.exec(cleanedText))!==null){latestMatch=match}if(!latestMatch)return null;try{const jsonStr=extractJsonCandidate(latestMatch[1]);if(!jsonStr){throw new Error("未找到合法的JSON对象")}console.log(`${PLUGIN_NAME} 提取到JSON字符串:`,jsonStr.substring(0,100)+"...");const jsonWithoutComments=stripJsonComments(jsonStr);const battleData=JSON.parse(jsonWithoutComments);console.log(`${PLUGIN_NAME} 解析到AI战斗数据:`,battleData);return normalizeP1P2Format(battleData)}catch(e){console.error(`${PLUGIN_NAME} 解析AI战斗数据失败:`,e);return null}}function detectTrainerType(name,type=""){const normalizedName=(name||"").toLowerCase().replace(/[^a-z0-9]/g,"");const playerKeywords=["player","玩家","主角","user"];const isPlayer=playerKeywords.some(kw=>normalizedName.includes(kw))||name==="{{user}}"||name.includes("{{user}}");if(isPlayer){return"player"}if(type.toLowerCase()==="wild"||normalizedName.includes("wild")||/野生/.test(name||"")){return"wild"}return"generated_trainer"}function processTrainerParty(trainer,defaultTier=2){const trainerName=trainer.name||"Unknown";const tier=trainer.tier||defaultTier;const trainerType=detectTrainerType(trainerName,trainer.type||"");console.log(`${PLUGIN_NAME} [DOUBLE] 处理训练家: ${trainerName}, 类型: ${trainerType}, Tier: ${tier}`);const playerKeywords=["player","玩家","主角","{{user}}","user"];const isPlayer=playerKeywords.some(kw=>trainerName.toLowerCase().includes(kw.toLowerCase()))||trainerName==="{{user}}"||trainerName.includes("{{user}}");let resolvedParty=[];let dbUnlocks=null;if(isPlayer){console.log(`${PLUGIN_NAME} [DOUBLE] "${trainerName}" 是玩家，队伍将从 ERA 变量提取`);resolvedParty=trainer.party||[]}else if(trainerType==="db_trainer"){if(trainer.party&&Array.isArray(trainer.party)){const hasDetailedParty=trainer.party.some(p=>typeof p==="object"&&(p.lv!==undefined||p.moves!==undefined));if(hasDetailedParty){console.log(`${PLUGIN_NAME} [DOUBLE] ${trainerName} 使用 AI 提供的详细队伍数据`);resolvedParty=trainer.party.map(p=>{if(typeof p==="string")return{name:p,_needGenerate:true,_tier:tier};return{...p,_needGenerate:true,_tier:tier}});const dbResult=extractPokemonFromTrainerDB(trainerName,[],tier);dbUnlocks=dbResult.unlocks}else{const pokemonNames=trainer.party.map(p=>typeof p==="string"?p:p.name);const dbResult=extractPokemonFromTrainerDB(trainerName,pokemonNames,tier);const dbPokemon=dbResult.party||dbResult;dbUnlocks=dbResult.unlocks;if(dbPokemon.length>0){resolvedParty=dbPokemon}else{console.log(`${PLUGIN_NAME} [DOUBLE] 数据库中找不到指定宝可梦，使用生成模式`);resolvedParty=trainer.party.map(p=>{if(typeof p==="string")return{name:p,_needGenerate:true,_tier:tier};return{...p,_needGenerate:true,_tier:tier}})}}}else{const dbResult=lookupTrainerFromDB(trainerName,tier);if(dbResult&&dbResult.party){resolvedParty=dbResult.party;dbUnlocks=dbResult.unlocks}}if(dbUnlocks){console.log(`${PLUGIN_NAME} [DOUBLE] ${trainerName} 数据库 unlocks:`,dbUnlocks)}}else if(trainerType==="wild"){console.log(`${PLUGIN_NAME} [DOUBLE] 野生模式，使用 AI 提供的数据`);resolvedParty=(trainer.party||[]).map(p=>{if(typeof p==="string")return{name:p,_needGenerate:true,_tier:tier};return{...p,_needGenerate:true,_tier:tier}})}else{console.log(`${PLUGIN_NAME} [DOUBLE] 生成式NPC "${trainerName}"，使用 AI 提供的数据`);resolvedParty=(trainer.party||[]).map(p=>{if(typeof p==="string")return{name:p,_needGenerate:true,_tier:tier};return{...p,_needGenerate:true,_tier:tier}})}const autoDetectedUnlocks=detectUnlocksFromParty(resolvedParty);const finalUnlocks=mergeUnlocks(trainer.unlocks,dbUnlocks,autoDetectedUnlocks);console.log(`${PLUGIN_NAME} [DOUBLE] ${trainerName} 最终 unlocks:`,finalUnlocks);return{name:trainerName,party:resolvedParty,trainerType:trainerType,isPlayer:isPlayer,tier:tier,unlocks:finalUnlocks,lines:trainer.lines}}function detectUnlocksFromParty(party){const detected={enable_mega:false,enable_dynamax:false,enable_tera:false,enable_z_move:false};if(!Array.isArray(party))return detected;for(const pokemon of party){const mechanic=(pokemon.mechanic||"").toLowerCase();if(mechanic==="mega")detected.enable_mega=true;if(mechanic==="dynamax"||mechanic==="gmax")detected.enable_dynamax=true;if(mechanic==="tera")detected.enable_tera=true;if(mechanic==="z_move"||mechanic==="zmove"||mechanic==="z")detected.enable_z_move=true}return detected}function mergeUnlocks(...unlocksList){const merged={enable_bond:false,enable_styles:false,enable_insight:false,enable_mega:false,enable_z_move:false,enable_dynamax:false,enable_tera:false,enable_proficiency_cap:false};for(const unlocks of unlocksList){if(!unlocks)continue;for(const key of Object.keys(merged)){if(unlocks[key]===true){merged[key]=true}}}return merged}function mergeTrainerParties(trainersData){const allParty=[];const trainerMetadata=[];const names=[];trainersData.forEach(t=>{names.push(t.name);t.party.forEach(p=>{allParty.push(p);trainerMetadata.push(t.name)})});if(allParty.length>6){console.log(`${PLUGIN_NAME} [DOUBLE] 队伍超过6只 (${allParty.length})，随机剔除至6只`);const indices=allParty.map((_,i)=>i);for(let i=indices.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[indices[i],indices[j]]=[indices[j],indices[i]]}const keepIndices=indices.slice(0,6).sort((a,b)=>a-b);const trimmedParty=keepIndices.map(i=>allParty[i]);const trimmedMetadata=keepIndices.map(i=>trainerMetadata[i]);console.log(`${PLUGIN_NAME} [DOUBLE] 剔除后队伍: ${trimmedParty.map(p=>typeof p==="string"?p:p.name).join(", ")}`);return{party:trimmedParty,trainerMetadata:trimmedMetadata,names:names.join(" & ")}}return{party:allParty,trainerMetadata:trainerMetadata,names:names.join(" & ")}}function normalizeP1P2Format(battleData){if(battleData.player||battleData.enemy){return battleData}if(!battleData.p1&&!battleData.p2){return battleData}console.log(`${PLUGIN_NAME} ========== 双打模式转换开始 ==========`);const normalized={difficulty:battleData.difficulty||"normal",battle_type:battleData.battle_type||"double"};const defaultTier=battleData.tier||2;if(battleData.p1){const p1Entrants=battleData.p1.entrants||battleData.p1.trainers;if(p1Entrants&&Array.isArray(p1Entrants)){console.log(`${PLUGIN_NAME} [P1] 多实体模式: ${p1Entrants.length} 人`);const trainersData=p1Entrants.map(t=>processTrainerParty(t,defaultTier));const merged=mergeTrainerParties(trainersData);console.log(`${PLUGIN_NAME} [P1] 各训练家 unlocks:`,trainersData.map(t=>({name:t.name,unlocks:t.unlocks})));const mergedUnlocks=mergeUnlocks(...trainersData.map(t=>t.unlocks));console.log(`${PLUGIN_NAME} [P1] 合并后的 unlocks:`,mergedUnlocks);normalized.player={name:merged.names,party:merged.party,_trainerMetadata:merged.trainerMetadata,_trainersData:trainersData,unlocks:battleData.p1.unlocks||mergedUnlocks};console.log(`${PLUGIN_NAME} [P1] 转换完成: ${merged.names}, 队伍: ${merged.party.map(p=>typeof p==="string"?p:p.name).join(", ")}`)}else{normalized.player=battleData.p1}}if(battleData.p2){const p2Entrants=battleData.p2.entrants||battleData.p2.trainers;if(p2Entrants&&Array.isArray(p2Entrants)){console.log(`${PLUGIN_NAME} [P2] 多实体模式: ${p2Entrants.length} 人`);const trainersData=p2Entrants.map(t=>processTrainerParty(t,defaultTier));const merged=mergeTrainerParties(trainersData);const hasWild=trainersData.some(t=>t.trainerType==="wild");const allDbTrainers=trainersData.every(t=>t.trainerType==="db_trainer");const firstWithLines=trainersData.find(t=>t.lines);const mergedUnlocks=mergeUnlocks(...trainersData.map(t=>t.unlocks));normalized.enemy={type:hasWild?"wild":"trainer",name:merged.names,party:merged.party,_trainerMetadata:merged.trainerMetadata,_trainersData:trainersData,lines:battleData.p2.lines||(firstWithLines?firstWithLines.lines:{}),unlocks:battleData.p2.unlocks||mergedUnlocks,_allDbTrainers:allDbTrainers};console.log(`${PLUGIN_NAME} [P2] 转换完成: ${merged.names}, 类型: ${normalized.enemy.type}`)}else{const trainerData=processTrainerParty({name:battleData.p2.name,party:battleData.p2.party,tier:battleData.p2.tier||defaultTier,type:battleData.p2.type,unlocks:battleData.p2.unlocks,lines:battleData.p2.lines},defaultTier);normalized.enemy={type:trainerData.trainerType==="wild"?"wild":"trainer",name:trainerData.name,party:trainerData.party,lines:battleData.p2.lines||{},unlocks:battleData.p2.unlocks||trainerData.unlocks,tier:battleData.p2.tier};console.log(`${PLUGIN_NAME} [P2] 单训练家: ${trainerData.name}, 类型: ${trainerData.trainerType}`)}}if(battleData.environment){normalized.environment=battleData.environment;console.log(`${PLUGIN_NAME} [ENV] 保留 AI 传入的环境配置:`,battleData.environment.overlay?.env_name||battleData.environment.weather||"none")}if(battleData.script){normalized.script=battleData.script}if(battleData.settings){normalized.settings=battleData.settings}console.log(`${PLUGIN_NAME} ========== 双打模式转换完成 ==========`);return normalized}function sanitizeMoves(moves){if(!Array.isArray(moves))return[];return moves.map(m=>typeof m==="string"?m.trim():"").filter(Boolean).slice(0,4)}function autoDetectSpecialForm(pokemonName){if(!pokemonName)return null;const name=pokemonName.toLowerCase().trim();if(name==="kyogre"||name==="groudon"){return"primal"}if(name==="zacian"||name==="zamazenta"){return"crowned"}return null}const NATURES=["Hardy","Lonely","Brave","Adamant","Naughty","Bold","Docile","Relaxed","Impish","Lax","Timid","Hasty","Serious","Jolly","Naive","Modest","Mild","Quiet","Bashful","Rash","Calm","Gentle","Sassy","Careful","Quirky"];function getTrainerDatabase(){return{}}function generateRandomIVs(quality="normal"){const roll=()=>Math.floor(Math.random()*32);switch(quality){case"low":return{hp:Math.floor(Math.random()*16),atk:Math.floor(Math.random()*16),def:Math.floor(Math.random()*16),spa:Math.floor(Math.random()*16),spd:Math.floor(Math.random()*16),spe:Math.floor(Math.random()*16)};case"high":const highIvs={hp:roll(),atk:roll(),def:roll(),spa:roll(),spd:roll(),spe:roll()};const stats=["hp","atk","def","spa","spd","spe"];const perfectStats=stats.sort(()=>Math.random()-.5).slice(0,3);perfectStats.forEach(s=>highIvs[s]=31);return highIvs;case"perfect":return{hp:31,atk:31,def:31,spa:31,spd:31,spe:31};default:return{hp:roll(),atk:roll(),def:roll(),spa:roll(),spd:roll(),spe:roll()}}}function getRandomNature(){return NATURES[Math.floor(Math.random()*NATURES.length)]}function normalizePokemonName(rawName){if(!rawName)return"";let name=String(rawName).trim();const adjectiveMap=[{pattern:/-Alolan$/i,replacement:"-Alola"},{pattern:/\s+Alolan$/i,replacement:"-Alola"},{pattern:/-Galarian$/i,replacement:"-Galar"},{pattern:/\s+Galarian$/i,replacement:"-Galar"},{pattern:/-Hisuian$/i,replacement:"-Hisui"},{pattern:/\s+Hisuian$/i,replacement:"-Hisui"},{pattern:/-Paldean$/i,replacement:"-Paldea"},{pattern:/\s+Paldean$/i,replacement:"-Paldea"}];for(const{pattern:pattern,replacement:replacement}of adjectiveMap){if(pattern.test(name)){name=name.replace(pattern,replacement);console.log(`${PLUGIN_NAME} [NORMALIZE] "${rawName}" -> "${name}"`);break}}return name}function getPokemonDataSafe(pokemonName){if(!pokemonName||typeof POKEDEX==="undefined")return null;const normalizedName=normalizePokemonName(pokemonName);let id=normalizedName.toLowerCase().replace(/[^a-z0-9]/g,"");if(POKEDEX[id]){return{data:POKEDEX[id],usedName:normalizedName,fallbackType:"direct"}}const suffixFixes=[{from:"alolan",to:"alola"},{from:"galarian",to:"galar"},{from:"hisuian",to:"hisui"},{from:"paldean",to:"paldea"}];for(const fix of suffixFixes){if(id.endsWith(fix.from)){const fixedId=id.slice(0,-fix.from.length)+fix.to;if(POKEDEX[fixedId]){console.log(`${PLUGIN_NAME} [SUFFIX FIX] "${id}" -> "${fixedId}"`);return{data:POKEDEX[fixedId],usedName:normalizedName,fallbackType:"suffix_fix"}}}}console.warn(`${PLUGIN_NAME} [FALLBACK] Data missing for "${pokemonName}" (normalized: "${normalizedName}", id: "${id}"). Trying base form...`);const splitChars=["-"," "];for(const splitChar of splitChars){if(normalizedName.includes(splitChar)){const potentialBaseName=normalizedName.split(splitChar)[0];if(potentialBaseName&&potentialBaseName!==normalizedName){const baseId=potentialBaseName.toLowerCase().replace(/[^a-z0-9]/g,"");if(POKEDEX[baseId]){console.log(`${PLUGIN_NAME} [FALLBACK SUCCESS] Using base species "${potentialBaseName}" (id: "${baseId}") instead of "${normalizedName}"`);return{data:POKEDEX[baseId],usedName:potentialBaseName,fallbackType:"base_form"}}}}}console.error(`${PLUGIN_NAME} [FATAL] Pokemon "${pokemonName}" totally unknown. No fallback available.`);return null}function getRandomAbility(pokemonName){if(typeof POKEDEX==="undefined")return null;const result=getPokemonDataSafe(pokemonName);if(!result||!result.data||!result.data.abilities)return null;const data=result.data;const abilities=[];if(data.abilities["0"])abilities.push(data.abilities["0"]);if(data.abilities["1"])abilities.push(data.abilities["1"]);if(data.abilities["H"]&&Math.random()<.2){abilities.push(data.abilities["H"])}if(abilities.length===0)return null;return abilities[Math.floor(Math.random()*abilities.length)]}function getRandomMoves(pokemonName,level=50){if(typeof POKEDEX==="undefined"||typeof MOVES==="undefined"){return["Tackle","Scratch","Growl","Leer"]}const result=getPokemonDataSafe(pokemonName);if(!result||!result.data)return["Tackle","Scratch","Growl","Leer"];const data=result.data;const pokemonTypes=data.types||["Normal"];const candidateMoves=[];for(const moveId in MOVES){const move=MOVES[moveId];if(!move||move.category==="Status")continue;if(pokemonTypes.includes(move.type)||move.type==="Normal"){if(move.basePower&&move.basePower>0&&move.basePower<=100){candidateMoves.push(move.name)}}}const shuffled=candidateMoves.sort(()=>Math.random()-.5);return shuffled.slice(0,4)}function getTierDefaultLevel(tier){const tierLevelMap={1:25,2:50,3:75,4:85};return tierLevelMap[tier]||50}function generateWildPokemon(baseData,tier=null,isCustomNpc=false){const rawName=baseData.name||"Rattata";const name=normalizePokemonName(rawName);let level=baseData.lv||baseData.level;if(!level&&tier){level=getTierDefaultLevel(tier);console.log(`${PLUGIN_NAME} [GEN] 根据 tier ${tier} 推断等级: ${level}`)}if(!level){level=5}const shiny=baseData.shiny!==undefined?baseData.shiny:Math.random()<1/4096;let ivQuality=baseData.quality;if(!ivQuality){const isLegendary=["mewtwo","mew","lugia","hooh","rayquaza","dialga","palkia","giratina","reshiram","zekrom","kyurem","xerneas","yveltal","zygarde","solgaleo","lunala","necrozma","zacian","zamazenta","eternatus","koraidon","miraidon"].includes(name.toLowerCase().replace(/[^a-z0-9]/g,""));ivQuality=shiny?"high":isLegendary?"high":level>=50?"medium":"low"}const qualityMap={low:"low",medium:"normal",high:"high",perfect:"perfect"};const ivs=generateRandomIVs(qualityMap[ivQuality]||ivQuality);let evLevel=0;if(isCustomNpc){const evLevelMap={low:Math.min(30,Math.floor(level*.3)),medium:Math.min(100,Math.floor(level*.8)),high:Math.min(200,Math.floor(level*1.5)),perfect:252};evLevel=evLevelMap[ivQuality]||Math.min(30,Math.floor(level*.5))}const finalName=name;console.log(`${PLUGIN_NAME} [GEN] Pokemon name normalized: "${rawName}" -> "${finalName}"`);const nature=baseData.nature||getRandomNature();const ability=baseData.ability||getRandomAbility(finalName);const moves=baseData.moves&&baseData.moves.length>0?sanitizeMoves(baseData.moves):getRandomMoves(finalName,level);const gender=baseData.gender||(Math.random()>.5?"M":"F");const autoForm=autoDetectSpecialForm(finalName);return{name:finalName,gender:gender,lv:level,nature:nature,ability:ability,shiny:shiny,item:baseData.item||null,mechanic:baseData.mechanic||null,teraType:baseData.teraType||null,stats_meta:{ivs:ivs,ev_level:evLevel},moves:moves,mega:baseData.mega||autoForm}}function lookupTrainerFromDB(trainerName,tier=2){console.log(`${PLUGIN_NAME} [DEBUG] Mini版本：无固定NPC数据库，${trainerName} 将使用AI生成数据`);return null}function resolveEnemyParty(enemySource,aiBattleData){const tier=enemySource.tier||aiBattleData.tier||1;if(enemySource._trainersData&&Array.isArray(enemySource._trainersData)){console.log(`${PLUGIN_NAME} 双打格式敌方已预处理，直接使用`);const trainersWithParty=enemySource._trainersData.map(trainerData=>{const isCustomNpc=trainerData.trainerType!=="wild"&&trainerData.trainerType!=="db_trainer";let trainerParty=trainerData.party.map(p=>{if(p._needGenerate){const pokemonTier=p._tier||trainerData.tier||tier;const isWild=trainerData.trainerType==="wild";console.log(`${PLUGIN_NAME} [P2] 为 ${trainerData.name} 生成宝可梦: ${p.name} (Tier ${pokemonTier}, ${isWild?"野生":"自定义NPC"})`);return generateWildPokemon(p,pokemonTier,!isWild)}return p});trainerParty.sort((a,b)=>(b.lv||0)-(a.lv||0));return{name:trainerData.name,party:trainerParty,originalCount:trainerParty.length,trainerProficiency:trainerData.trainerProficiency||0}});const totalCount=trainersWithParty.reduce((sum,t)=>sum+t.originalCount,0);const finalParty=[];if(totalCount<=6){trainersWithParty.forEach(t=>{finalParty.push(...t.party);console.log(`${PLUGIN_NAME} [P2] ${t.name} 队伍: ${t.party.map(p=>p.name).join(", ")}`)})}else{console.log(`${PLUGIN_NAME} [P2] 总队伍数 ${totalCount} > 6，按比例分配`);const allocations=trainersWithParty.map(t=>{const ratio=t.originalCount/totalCount;const allocated=Math.max(1,Math.round(ratio*6));return{...t,allocated:allocated}});let totalAllocated=allocations.reduce((sum,a)=>sum+a.allocated,0);while(totalAllocated>6){const maxAlloc=allocations.filter(a=>a.allocated>1).sort((a,b)=>b.allocated-a.allocated)[0];if(maxAlloc){maxAlloc.allocated--;totalAllocated--}else break}allocations.forEach(alloc=>{const selected=alloc.party.slice(0,alloc.allocated);finalParty.push(...selected);console.log(`${PLUGIN_NAME} [P2] ${alloc.name} 分配 ${alloc.allocated}/${alloc.originalCount} 只: ${selected.map(p=>`${p.name}(Lv${p.lv})`).join(", ")}`)})}const autoDetectedUnlocks=detectUnlocksFromParty(finalParty);const finalUnlocks=mergeUnlocks(enemySource.unlocks,autoDetectedUnlocks);const maxProficiency=Math.max(...trainersWithParty.map(t=>t.trainerProficiency||0));console.log(`${PLUGIN_NAME} [多人合并] 选择最高 trainerProficiency: ${maxProficiency}`);return{party:finalParty,type:enemySource.type||"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:finalUnlocks,trainerProficiency:maxProficiency,difficulty:aiBattleData.difficulty||"normal"}}const aiProvidedParty=Array.isArray(enemySource.party)&&enemySource.party.length>0;const hasDetailedParty=aiProvidedParty&&enemySource.party.some(p=>typeof p==="object"&&(p.lv!==undefined||p.moves!==undefined));if(hasDetailedParty){const isCustomNpc=!isWild;console.log(`${PLUGIN_NAME} AI 指定了详细队伍数据，使用 AI 数据（${isWild?"野生":"自定义NPC"}模式）`);const generatedParty=enemySource.party.map(p=>{const baseData=typeof p==="string"?{name:p}:p;const pokemonTier=baseData._tier||tier;return generateWildPokemon(baseData,pokemonTier,isCustomNpc)});const autoDetectedUnlocks=detectUnlocksFromParty(generatedParty);const finalUnlocks=mergeUnlocks(enemySource.unlocks,autoDetectedUnlocks);const customProficiency=enemySource.trainerProficiency||0;return{party:generatedParty,type:isWild?"wild":"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:finalUnlocks,trainerProficiency:customProficiency,difficulty:aiBattleData.difficulty||"normal"}}if(!isWild&&enemyName&&enemyName!=="wild"){const dbResult=lookupTrainerFromDB(enemyName,tier);if(dbResult){let finalParty=dbResult.party;if(aiProvidedParty){console.log(`${PLUGIN_NAME} 从数据库 ${enemyName} Tier ${tier} 中筛选: ${enemySource.party.join(", ")}`);const requestedNames=enemySource.party.map(p=>typeof p==="string"?p.toLowerCase():(p.name||"").toLowerCase());finalParty=dbResult.party.filter(pokemon=>requestedNames.includes((pokemon.name||"").toLowerCase()));if(finalParty.length===0){console.warn(`${PLUGIN_NAME} 筛选后队伍为空，使用完整数据库队伍`);finalParty=dbResult.party}}return{party:finalParty,type:"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:dbResult.unlocks||null,trainerProficiency:dbResult.trainerProficiency||0,difficulty:aiBattleData.difficulty||dbResult.difficulty}}}if(aiProvidedParty){const isCustomNpc=!isWild;console.log(`${PLUGIN_NAME} 数据库未命中，根据 AI 提供的名字生成宝可梦（${isWild?"野生":"自定义NPC"}）`);const generatedParty=enemySource.party.map(p=>{const baseData=typeof p==="string"?{name:p}:p;const pokemonTier=baseData._tier||tier;return generateWildPokemon(baseData,pokemonTier,isCustomNpc)});const autoDetectedUnlocks=detectUnlocksFromParty(generatedParty);const finalUnlocks=mergeUnlocks(enemySource.unlocks,autoDetectedUnlocks);const customProficiency=enemySource.trainerProficiency||0;return{party:generatedParty,type:isWild?"wild":"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:finalUnlocks,trainerProficiency:customProficiency,difficulty:aiBattleData.difficulty||"normal"}}console.log(`${PLUGIN_NAME} 使用随机生成模式`);let rawParty=Array.isArray(aiBattleData.party)&&aiBattleData.party.length>0?aiBattleData.party:[];if(rawParty.length===0){rawParty=[{name:enemyName!=="wild"?enemyName:"Rattata",lv:5}]}const isCustomNpc=!isWild;const generatedParty=rawParty.map(p=>{const baseData=typeof p==="string"?{name:p}:p;const pokemonTier=baseData._tier||tier;return generateWildPokemon(baseData,pokemonTier,isCustomNpc)});return{party:generatedParty,type:isWild?"wild":"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:null,trainerProficiency:enemySource.trainerProficiency||0,difficulty:aiBattleData.difficulty||(isWild?"easy":"normal")}}function parsePartyData(party){console.log(`${PLUGIN_NAME} [DEBUG] parsePartyData 输入:`,typeof party,party);if(!party)return[];let partyArray=[];if(!Array.isArray(party)&&typeof party==="object"){const slotKeys=Object.keys(party).filter(k=>/^slot\d+$/.test(k)).sort((a,b)=>{const numA=parseInt(a.replace("slot",""));const numB=parseInt(b.replace("slot",""));return numA-numB});if(slotKeys.length>0){partyArray=slotKeys.map(k=>party[k]);console.log(`${PLUGIN_NAME} [DEBUG] 槽位格式转数组:`,partyArray.length,"个槽位")}else{const numKeys=Object.keys(party).filter(k=>/^\d+$/.test(k)).sort((a,b)=>Number(a)-Number(b));if(numKeys.length>0){partyArray=numKeys.map(k=>party[k]);console.log(`${PLUGIN_NAME} [DEBUG] 数字索引转数组:`,partyArray)}else if(party.name){partyArray=[party]}else{return[]}}}else if(Array.isArray(party)){partyArray=party}else{return[]}return partyArray.map((p,index)=>{if(!p)return null;if(typeof p==="string"){try{const parsed=JSON.parse(p);return normalizePokemonData(parsed,index)}catch(e){console.warn(`${PLUGIN_NAME} 解析宝可梦数据失败:`,p);return null}}if(p&&typeof p==="object"&&p["0"]!==undefined&&typeof p["0"]==="string"){const keys=Object.keys(p).filter(k=>/^\d+$/.test(k)).sort((a,b)=>Number(a)-Number(b));const jsonStr=keys.map(k=>p[k]).join("");console.log(`${PLUGIN_NAME} [DEBUG] 重组字符数组为 JSON:`,jsonStr.substring(0,50)+"...");try{const parsed=JSON.parse(jsonStr);return normalizePokemonData(parsed,index)}catch(e){console.warn(`${PLUGIN_NAME} 重组 JSON 解析失败:`,e);return null}}return normalizePokemonData(p,index)}).filter(p=>p!==null&&p.name)}function normalizePokemonData(pokemon,slotIndex){if(!pokemon||typeof pokemon!=="object")return null;let moves=[];if(pokemon.moves){if(Array.isArray(pokemon.moves)){moves=sanitizeMoves(pokemon.moves)}else if(typeof pokemon.moves==="object"){moves=sanitizeMoves([pokemon.moves.move1,pokemon.moves.move2,pokemon.moves.move3,pokemon.moves.move4])}}return{...pokemon,slot:pokemon.slot||slotIndex+1,moves:moves}}function isCompletePokemonData(pokemon){if(!pokemon||typeof pokemon!=="object")return false;return pokemon.name&&typeof pokemon.lv==="number"&&Array.isArray(pokemon.moves)&&pokemon.moves.length>0}function selectPokemonByNames(playerParty,nameList){if(!playerParty||!Array.isArray(playerParty))return[];if(!nameList||!Array.isArray(nameList))return[];console.log(`${PLUGIN_NAME} [DEBUG] 筛选宝可梦:`,nameList);console.log(`${PLUGIN_NAME} [DEBUG] 可用队伍:`,playerParty.map(p=>p.name||p.nickname));const result=[];for(const name of nameList){const normalizedName=(typeof name==="string"?name:name?.name||"").toLowerCase();let found=playerParty.find(p=>p.name?.toLowerCase()===normalizedName||p.nickname?.toLowerCase()===normalizedName);if(!found){const baseName=normalizedName.split("-")[0];found=playerParty.find(p=>{const pokemonName=(p.name||"").toLowerCase();const pokemonBaseName=pokemonName.split("-")[0];return pokemonBaseName===baseName||pokemonName.includes(normalizedName)||normalizedName.includes(pokemonName)});if(found){console.log(`${PLUGIN_NAME} [DEBUG] 部分匹配成功: "${name}" -> "${found.name}"`)}}if(found){result.push(found)}else{console.warn(`${PLUGIN_NAME} 未在玩家队伍中找到: ${name}`)}}console.log(`${PLUGIN_NAME} [DEBUG] 筛选结果:`,result.map(p=>p.name));return result}function resolveTrainerParty(aiTrainerConfig,eraPlayerData,role="trainer"){const trainerName=aiTrainerConfig?.name||eraPlayerData?.name||"训练家";const playerKeywords=["player","玩家","主角","训练家","{{user}}","user"];const normalizedName=trainerName.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g,"");const isPlayer=playerKeywords.some(kw=>normalizedName.includes(kw)||trainerName.includes(kw))||trainerName==="{{user}}"||trainerName.includes("{{user}}");console.log(`${PLUGIN_NAME} [${role}] 解析训练家: "${trainerName}", 是否玩家: ${isPlayer}`);const isDoubleBattle=trainerName.includes("&");if(isDoubleBattle&&aiTrainerConfig._trainersData&&Array.isArray(aiTrainerConfig._trainersData)){console.log(`${PLUGIN_NAME} [${role}] 双打对战模式，分别处理各训练家队伍`);const eraParty=parsePartyData(eraPlayerData?.party);const trainersWithParty=aiTrainerConfig._trainersData.map(trainerData=>{let trainerParty=[];if(trainerData.isPlayer){if(trainerData.party&&trainerData.party.length>0){trainerParty=trainerData.party.map(p=>{const pokemonName=typeof p==="string"?p:p?.name;return selectPokemonByNames(eraParty,[pokemonName])[0]}).filter(Boolean)}else{trainerParty=eraParty}}else{const isWild=trainerData.trainerType==="wild";trainerParty=trainerData.party.map(p=>{if(p._needGenerate){const pokemonTier=p._tier||trainerData.tier||2;console.log(`${PLUGIN_NAME} [${role}] 为 ${trainerData.name} 生成宝可梦: ${p.name} (Tier ${pokemonTier}, ${isWild?"野生":"自定义NPC"})`);return generateWildPokemon(p,pokemonTier,!isWild)}console.log(`${PLUGIN_NAME} [${role}] 使用数据库数据: ${p.name}, mechanic: ${p.mechanic||"null"}, _needGenerate: ${p._needGenerate}`);return p})}trainerParty.sort((a,b)=>(b.lv||0)-(a.lv||0));return{name:trainerData.name,party:trainerParty,originalCount:trainerParty.length,trainerProficiency:trainerData.trainerProficiency||0}});const totalCount=trainersWithParty.reduce((sum,t)=>sum+t.originalCount,0);const finalParty=[];if(totalCount<=6){trainersWithParty.forEach(t=>{finalParty.push(...t.party);console.log(`${PLUGIN_NAME} [${role}] ${t.name} 队伍: ${t.party.map(p=>p.name).join(", ")}`)})}else{console.log(`${PLUGIN_NAME} [${role}] 总队伍数 ${totalCount} > 6，按比例分配`);const allocations=trainersWithParty.map(t=>{const ratio=t.originalCount/totalCount;const allocated=Math.max(1,Math.round(ratio*6));return{...t,allocated:allocated}});let totalAllocated=allocations.reduce((sum,a)=>sum+a.allocated,0);while(totalAllocated>6){const maxAlloc=allocations.filter(a=>a.allocated>1).sort((a,b)=>b.allocated-a.allocated)[0];if(maxAlloc){maxAlloc.allocated--;totalAllocated--}else break}allocations.forEach(alloc=>{const selected=alloc.party.slice(0,alloc.allocated);finalParty.push(...selected);console.log(`${PLUGIN_NAME} [${role}] ${alloc.name} 分配 ${alloc.allocated}/${alloc.originalCount} 只: ${selected.map(p=>`${p.name}(Lv${p.lv})`).join(", ")}`)})}const trainerUnlocks=aiTrainerConfig._trainersData.map(t=>t.unlocks).filter(Boolean);const mergedUnlocks=mergeUnlocks(aiTrainerConfig.unlocks,...trainerUnlocks);console.log(`${PLUGIN_NAME} [${role}] aiTrainerConfig.unlocks:`,aiTrainerConfig.unlocks);console.log(`${PLUGIN_NAME} [${role}] 训练家 unlocks:`,trainerUnlocks);console.log(`${PLUGIN_NAME} [${role}] 最终合并 unlocks:`,mergedUnlocks);finalParty.forEach(p=>{if(p.mechanic){console.log(`${PLUGIN_NAME} [${role}] finalParty 中 ${p.name} 的 mechanic: ${p.mechanic}`)}});const maxProficiency=Math.max(...trainersWithParty.map(t=>t.trainerProficiency||0));console.log(`${PLUGIN_NAME} [${role}] [多人合并] 选择最高 trainerProficiency: ${maxProficiency}`);return{name:trainerName,unlocks:mergedUnlocks,party:finalParty,trainerProficiency:maxProficiency}}const eraParty=parsePartyData(eraPlayerData?.party);if(!aiTrainerConfig?.party||!Array.isArray(aiTrainerConfig.party)||aiTrainerConfig.party.length===0){if(isPlayer){console.log(`${PLUGIN_NAME} [${role}] 模式: 玩家全队配置`);return{name:trainerName,unlocks:null,party:eraParty.length>0?eraParty:[{name:"Pikachu",lv:5,moves:["Thunder Shock","Quick Attack"]}]}}else{console.log(`${PLUGIN_NAME} [${role}] 模式: NPC数据库查询（无party指定）`);const dbResult=extractPokemonFromTrainerDB(trainerName,[],2);const dbParty=dbResult.party||dbResult;const dbUnlocks=dbResult.unlocks||null;if(dbParty.length>0){return{name:trainerName,unlocks:dbUnlocks,party:dbParty}}else{if(role==="p1"&&eraParty.length>0){console.log(`${PLUGIN_NAME} [${role}] NPC "${trainerName}" 不在数据库中，但 role=p1，使用 ERA 玩家数据`);return{name:trainerName,unlocks:null,party:eraParty}}console.warn(`${PLUGIN_NAME} [${role}] NPC "${trainerName}" 不在数据库中，使用默认队伍`);return{name:trainerName,unlocks:null,party:[{name:"Pikachu",lv:5,moves:["Thunder Shock","Quick Attack"]}]}}}}const aiParty=aiTrainerConfig.party;const trainerMetadata=aiTrainerConfig._trainerMetadata||[];const hasCompleteData=aiParty.some(p=>isCompletePokemonData(p));const hasStringData=aiParty.some(p=>typeof p==="string");if(hasCompleteData&&!hasStringData){console.log(`${PLUGIN_NAME} [${role}] 模式: AI完整数据`);const partyWithMega=aiParty.map((p,index)=>({...p,moves:sanitizeMoves(p.moves),mega:p.mega,trainer:trainerMetadata[index]}));return{name:trainerName,unlocks:null,party:partyWithMega}}if(hasCompleteData&&hasStringData){console.log(`${PLUGIN_NAME} [${role}] 模式: 混合数据`);const finalParty=[];for(let i=0;i<aiParty.length;i++){const p=aiParty[i];if(isCompletePokemonData(p)){finalParty.push({...p,moves:sanitizeMoves(p.moves),trainer:trainerMetadata[i]})}else{const pokemonName=typeof p==="string"?p:p?.name;let found=null;if(isPlayer&&eraParty.length>0){found=selectPokemonByNames(eraParty,[pokemonName])[0]}else{const dbResult=extractPokemonFromTrainerDB(trainerName,[pokemonName],2);const dbParty=dbResult.party||dbResult;found=dbParty[0]}if(found){finalParty.push({...found,trainer:trainerMetadata[i]})}else{console.warn(`${PLUGIN_NAME} [${role}] 未找到: ${pokemonName}`)}}}return{name:trainerName,unlocks:null,party:finalParty}}console.log(`${PLUGIN_NAME} [${role}] 模式: 按名字筛选`);const nameList=aiParty.map(p=>typeof p==="string"?p:p?.name).filter(Boolean);let selectedParty=[];let trainerUnlocks=null;if(isPlayer&&eraParty.length>0){selectedParty=selectPokemonByNames(eraParty,nameList)}else{const dbResult=extractPokemonFromTrainerDB(trainerName,nameList,2);selectedParty=dbResult.party||dbResult;trainerUnlocks=dbResult.unlocks||null;if(selectedParty.length===0&&role==="p1"&&eraParty.length>0){console.log(`${PLUGIN_NAME} [${role}] NPC "${trainerName}" 不在数据库中，但 role=p1，尝试从 ERA 筛选`);selectedParty=selectPokemonByNames(eraParty,nameList)}}if(selectedParty.length===0){console.warn(`${PLUGIN_NAME} [${role}] 筛选结果为空`);if((isPlayer||role==="p1")&&eraParty.length>0){console.log(`${PLUGIN_NAME} [${role}] 使用 ERA 全队作为后备`);selectedParty=eraParty}else{selectedParty=[{name:"Pikachu",lv:5,moves:["Thunder Shock","Quick Attack"]}]}}if(isDoubleBattle){console.log(`${PLUGIN_NAME} [${role}] 检测到双人对战格式: ${trainerName}`);if(trainerMetadata.length>0){const partyWithTrainers=selectedParty.map((pokemon,index)=>({...pokemon,trainer:trainerMetadata[index]||trainerName.split("&")[0].trim()}));return{name:trainerName,unlocks:trainerUnlocks,party:partyWithTrainers}}else{const trainerNames=trainerName.split("&").map(n=>n.trim());const midPoint=Math.ceil(selectedParty.length/2);const partyWithTrainers=selectedParty.map((pokemon,index)=>({...pokemon,trainer:index<midPoint?trainerNames[0]:trainerNames[1]||trainerNames[0]}));return{name:trainerName,unlocks:trainerUnlocks,party:partyWithTrainers}}}return{name:trainerName,unlocks:trainerUnlocks,party:selectedParty}}function resolveEnemyData(enemySource,aiBattleData){const rawType=(enemySource.type||"").toString().toLowerCase();const isWild=rawType==="wild";const enemyName=enemySource.name||(isWild?"wild":"Trainer");const enemyLines=enemySource.lines||{};const enemyId=enemySource.id||enemyName;const tier=enemySource.tier||aiBattleData.tier||2;if(enemySource._trainersData&&Array.isArray(enemySource._trainersData)){console.log(`${PLUGIN_NAME} 双打格式敌方已预处理，直接使用`);const trainersWithParty=enemySource._trainersData.map(trainerData=>{const isWildTrainer=trainerData.trainerType==="wild";let trainerParty=trainerData.party.map(p=>{if(p._needGenerate){const pokemonTier=p._tier||trainerData.tier||tier;console.log(`${PLUGIN_NAME} [P2] 为 ${trainerData.name} 生成宝可梦: ${p.name} (Tier ${pokemonTier}, ${isWildTrainer?"野生":"自定义NPC"})`);return generateWildPokemon(p,pokemonTier,!isWildTrainer)}return p});trainerParty.sort((a,b)=>(b.lv||0)-(a.lv||0));return{name:trainerData.name,party:trainerParty,originalCount:trainerParty.length,trainerProficiency:trainerData.trainerProficiency||0}});const totalCount=trainersWithParty.reduce((sum,t)=>sum+t.originalCount,0);const finalParty=[];if(totalCount<=6){trainersWithParty.forEach(t=>{finalParty.push(...t.party);console.log(`${PLUGIN_NAME} [P2] ${t.name} 队伍: ${t.party.map(p=>p.name).join(", ")}`)})}else{console.log(`${PLUGIN_NAME} [P2] 总队伍数 ${totalCount} > 6，按比例分配`);const allocations=trainersWithParty.map(t=>{const ratio=t.originalCount/totalCount;const allocated=Math.max(1,Math.round(ratio*6));return{...t,allocated:allocated}});let totalAllocated=allocations.reduce((sum,a)=>sum+a.allocated,0);while(totalAllocated>6){const maxAlloc=allocations.filter(a=>a.allocated>1).sort((a,b)=>b.allocated-a.allocated)[0];if(maxAlloc){maxAlloc.allocated--;totalAllocated--}else break}allocations.forEach(alloc=>{const selected=alloc.party.slice(0,alloc.allocated);finalParty.push(...selected);console.log(`${PLUGIN_NAME} [P2] ${alloc.name} 分配 ${alloc.allocated}/${alloc.originalCount} 只: ${selected.map(p=>`${p.name}(Lv${p.lv})`).join(", ")}`)})}const autoDetectedUnlocks=detectUnlocksFromParty(finalParty);const finalUnlocks=mergeUnlocks(enemySource.unlocks,autoDetectedUnlocks);const maxProficiency=Math.max(...trainersWithParty.map(t=>t.trainerProficiency||0));return{party:finalParty,type:enemySource.type||"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:finalUnlocks,trainerProficiency:maxProficiency,difficulty:aiBattleData.difficulty||"normal"}}const aiProvidedParty=Array.isArray(enemySource.party)&&enemySource.party.length>0;const hasDetailedParty=aiProvidedParty&&enemySource.party.some(p=>typeof p==="object"&&(p.lv!==undefined||p.moves!==undefined));if(hasDetailedParty||aiProvidedParty){const isCustomNpc=!isWild;console.log(`${PLUGIN_NAME} [Mini] 使用 AI 数据生成敌方（${isWild?"野生":"自定义NPC"}模式）`);const generatedParty=enemySource.party.map(p=>{const baseData=typeof p==="string"?{name:p}:p;const pokemonTier=baseData._tier||tier;return generateWildPokemon(baseData,pokemonTier,isCustomNpc)});const autoDetectedUnlocks=detectUnlocksFromParty(generatedParty);const finalUnlocks=mergeUnlocks(enemySource.unlocks,autoDetectedUnlocks);return{party:generatedParty,type:isWild?"wild":"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:finalUnlocks,trainerProficiency:enemySource.trainerProficiency||0,difficulty:aiBattleData.difficulty||"normal"}}console.log(`${PLUGIN_NAME} [Mini] 使用随机生成模式`);let rawParty=Array.isArray(aiBattleData.party)&&aiBattleData.party.length>0?aiBattleData.party:[{name:enemyName!=="wild"?enemyName:"Rattata",lv:5}];const isCustomNpc=!isWild;const generatedParty=rawParty.map(p=>{const baseData=typeof p==="string"?{name:p}:p;const pokemonTier=baseData._tier||tier;return generateWildPokemon(baseData,pokemonTier,isCustomNpc)});return{party:generatedParty,type:isWild?"wild":"trainer",name:enemyName,id:enemyId,lines:enemyLines,unlocks:null,trainerProficiency:enemySource.trainerProficiency||0,difficulty:aiBattleData.difficulty||(isWild?"easy":"normal")}}async function buildCompleteBattleJson(aiBattleData){const eraPlayerData=await getPlayerParty();if(!eraPlayerData||!eraPlayerData.party||eraPlayerData.party.length===0){console.warn(`${PLUGIN_NAME} ERA玩家队伍为空（如果是纯NPC对战则无影响）`)}const p1Source=aiBattleData.player||aiBattleData.p1||{};const p2Source=aiBattleData.enemy||aiBattleData.p2||{};const resolvedPlayer=resolveTrainerParty(p1Source,eraPlayerData,"p1");const resolvedEnemy=resolveEnemyData(p2Source,aiBattleData);const eraBonds=eraPlayerData?.bonds||{};const playerUnlocks=mergeUnlocks(resolvedPlayer.unlocks,eraPlayerData?.unlocks,eraBonds);const enemyUnlocks=resolvedEnemy.unlocks||null;const defaultSettings={enableAVS:true,enableCommander:true,enableEVO:true,enableBGM:true,enableSFX:true,enableClash:false,enableEnvironment:true};const eraSettings=eraPlayerData?.settings||{};const aiSettings=aiBattleData?.settings||{};const finalSettings={...defaultSettings,...eraSettings,...aiSettings};const eraProficiency=eraPlayerData?.trainerProficiency||0;const resolvedProficiency=resolvedPlayer.trainerProficiency||0;const trainerProficiency=Math.min(255,Math.max(0,Math.max(eraProficiency,resolvedProficiency)));const eraVars=await getEraVars();let environmentConfig=null;let eraWeather=null;let eraSuppression=null;if(eraVars){const locationData=getEraValue(eraVars,"world_state.location",null);const weatherGrid=getEraValue(eraVars,"world_state.weather_grid",null);if(locationData&&weatherGrid&&typeof locationData.x==="number"){const MAP_CENTER_X=26;const MAP_CENTER_Y=26;let gx=locationData.x;if(gx>0)gx-=1;gx=gx+MAP_CENTER_X;let gy=locationData.y;if(gy>0)gy-=1;gy=MAP_CENTER_Y-gy-1;const gridKey=`${gx}_${gy}`;const gridWeather=weatherGrid[gridKey];if(gridWeather){eraWeather=gridWeather.weather;eraSuppression=gridWeather.suppression||null;console.log(`${PLUGIN_NAME} [ERA WEATHER] 当前格子天气: ${eraWeather} @ ${gridKey}`)}}}const aiEnv=aiBattleData.environment||{};const finalWeather=aiEnv.weather?aiEnv.weather:eraWeather;const finalWeatherTurns=aiEnv.weatherTurns||0;const finalSuppression=aiEnv.suppression||eraSuppression;if(finalWeather||aiEnv.overlay){environmentConfig={weather:finalWeather,weatherTurns:finalWeatherTurns};if(aiEnv.overlay){environmentConfig.overlay=aiEnv.overlay;console.log(`${PLUGIN_NAME} [ENV OVERLAY] AI 传入自定义环境: ${aiEnv.overlay.env_name}`);console.log(`${PLUGIN_NAME} [ENV OVERLAY] 规则数: ${aiEnv.overlay.rules?.length||0}`)}if(finalSuppression){environmentConfig.suppression=finalSuppression}const weatherSource=aiEnv.weather!==undefined?"AI":eraWeather?"ERA":"none";console.log(`${PLUGIN_NAME} [ENVIRONMENT] 最终配置 - 天气: ${finalWeather||"none"} (来源: ${weatherSource}), overlay: ${aiEnv.overlay?"AI":"none"}`)}const completeBattle={settings:finalSettings,difficulty:resolvedEnemy.difficulty||aiBattleData.difficulty||"normal",player:{name:resolvedPlayer.name,trainerProficiency:trainerProficiency,party:resolvedPlayer.party,unlocks:playerUnlocks},enemy:{id:resolvedEnemy.id,type:resolvedEnemy.type,name:resolvedEnemy.name,trainerProficiency:resolvedEnemy.trainerProficiency||0,lines:resolvedEnemy.lines,unlocks:enemyUnlocks},party:resolvedEnemy.party,script:aiBattleData.script||null};if(environmentConfig){completeBattle.environment=environmentConfig}console.log(`${PLUGIN_NAME} 构建完整战斗JSON:`,completeBattle);console.log(`${PLUGIN_NAME} [SETTINGS] 全局系统开关:`,finalSettings);console.log(`${PLUGIN_NAME} [PROFICIENCY] 玩家熟练度:`,trainerProficiency);console.log(`${PLUGIN_NAME} [PROFICIENCY] 敌方熟练度:`,resolvedEnemy.trainerProficiency||0);console.log(`${PLUGIN_NAME} [UNLOCK] player unlocks:`,playerUnlocks);if(enemyUnlocks){console.log(`${PLUGIN_NAME} [UNLOCK] enemy unlocks:`,enemyUnlocks)}return completeBattle}async function injectBattleFrontend(messageId,battleJson){try{const messages=getChatMessages(messageId);if(!messages||messages.length===0)return false;const msg=messages[0];let content=msg.message;const normalizePokemonFormat=pokemon=>{if(!pokemon)return pokemon;if(typeof pokemon.bonds==="number"){const bondsValue=pokemon.bonds;pokemon.avs={trust:bondsValue,passion:bondsValue,insight:bondsValue,devotion:bondsValue};console.log(`${PLUGIN_NAME} [BONDS] ${pokemon.name}: bonds=${bondsValue} → avs={T:${bondsValue}/P:${bondsValue}/I:${bondsValue}/D:${bondsValue}}`)}else if(pokemon.friendship&&pokemon.friendship.avs){pokemon.avs={...pokemon.friendship.avs};delete pokemon.friendship}else if(pokemon.friendship&&!pokemon.friendship.avs){if(typeof pokemon.friendship==="object"&&("trust"in pokemon.friendship||"passion"in pokemon.friendship)){pokemon.avs={...pokemon.friendship};delete pokemon.friendship}}if(!pokemon.avs){pokemon.avs={trust:0,passion:0,insight:0,devotion:0}}if(pokemon.mechanic){console.log(`${PLUGIN_NAME} [MECHANIC] ${pokemon.name}: ${pokemon.mechanic}${pokemon.teraType?` (${pokemon.teraType})`:""}`)}if(pokemon.isAce!==undefined){pokemon.isAce=Boolean(pokemon.isAce)}if(pokemon.isLead!==undefined){pokemon.isLead=Boolean(pokemon.isLead);if(pokemon.isLead){console.log(`${PLUGIN_NAME} [LEAD] ${pokemon.name} marked as lead Pokemon`)}}return pokemon};if(battleJson.player&&battleJson.player.party){battleJson.player.party=battleJson.player.party.map(normalizePokemonFormat)}if(battleJson.party){battleJson.party=battleJson.party.map(normalizePokemonFormat)}const frontendPayload=`<PKM_FRONTEND>\n${JSON.stringify(battleJson)}\n</PKM_FRONTEND>`;content=content.trim()+"\n\n"+frontendPayload;await setChatMessages([{message_id:messageId,message:content}],{refresh:"affected"});console.log(`${PLUGIN_NAME} ✓ 战斗前端已注入到消息 #${messageId}`);return true}catch(e){console.error(`${PLUGIN_NAME} 注入前端失败:`,e);return false}}function resetState(reason){console.log(`${PLUGIN_NAME} ${reason} -> 重置状态`);lastHandledMk=null;isProcessing=false}function formatIVsDisplay(ivs){if(!ivs)return"???";const stats=["hp","atk","def","spa","spd","spe"];let perfectCount=0;let zeroAtk=false;for(const stat of stats){const val=ivs[stat];if(val===31)perfectCount++;if(stat==="atk"&&val===0)zeroAtk=true}if(perfectCount===6)return"6V";if(perfectCount===5&&zeroAtk)return"5V0A";if(perfectCount>=4)return`${perfectCount}V`;return`${perfectCount}V`}function formatGender(gender){if(gender==="M")return"♂";if(gender==="F")return"♀";return"⚪"}function generateIVsByQuality(quality){const targets={low:90,medium:120,high:150,perfect:186};const targetSum=targets[quality]||targets["low"];if(quality==="perfect"){return{hp:31,atk:31,def:31,spa:31,spd:31,spe:31}}const stats=["hp","atk","def","spa","spd","spe"];const ivs={};let remaining=targetSum;for(let i=0;i<stats.length;i++){const stat=stats[i];if(i===stats.length-1){ivs[stat]=Math.min(31,Math.max(0,remaining))}else{const maxForThis=Math.min(31,remaining-(stats.length-i-1)*0);const minForThis=Math.max(0,remaining-(stats.length-i-1)*31);ivs[stat]=Math.floor(Math.random()*(maxForThis-minForThis+1))+minForThis;remaining-=ivs[stat]}}return ivs}function isValidIVs(ivs){if(!ivs||typeof ivs!=="object")return false;const requiredStats=["hp","atk","def","spa","spd","spe"];return requiredStats.every(stat=>typeof ivs[stat]==="number"&&ivs[stat]>=0&&ivs[stat]<=31)}function autoFillStatsMeta(pokemon){const statsMeta=pokemon.stats_meta||{};let ivs=statsMeta.ivs;let evLevel=statsMeta.ev_level;if(!isValidIVs(ivs)){const quality=pokemon.quality||pokemon.iv_quality||null;if(quality&&["low","medium","high","perfect"].includes(quality)){ivs=generateIVsByQuality(quality)}else{const rand=Math.random();let randomQuality;if(rand<.3)randomQuality="low";else if(rand<.7)randomQuality="medium";else if(rand<.95)randomQuality="high";else randomQuality="perfect";ivs=generateIVsByQuality(randomQuality)}console.log(`${PLUGIN_NAME} [IVs] 为 ${pokemon.name} 生成新 IVs:`,ivs)}else{console.log(`${PLUGIN_NAME} [IVs] ${pokemon.name} 已有 IVs，保持不变`)}const lv=typeof pokemon.lv==="number"?pokemon.lv:typeof pokemon.level==="number"?pokemon.level:5;const calculatedEV=Math.min(252,Math.floor(lv*2.5));if(evLevel===undefined||evLevel===null){evLevel=calculatedEV}else{evLevel=Math.max(evLevel,calculatedEV)}return{ivs:ivs,ev_level:evLevel}}function generatePlayerDataPrompt(playerData){const parsedParty=parsePartyData(playerData?.party);if(!playerData||parsedParty.length===0){return null}const playerName=playerData?.name||"训练家";const unlocks=playerData?.unlocks||{};const partyCount=parsedParty.length;const partyLines=Array.from({length:6}).map((_,idx)=>{const slotNum=idx+1;const pokemon=parsedParty.find(p=>(p.slot||slotNum)===slotNum);if(!pokemon){return`slot${slotNum}. —`}const name=pokemon.nickname||pokemon.name||`Pokemon ${slotNum}`;const level=typeof pokemon.lv==="number"?pokemon.lv:typeof pokemon.level==="number"?pokemon.level:"??";const gender=formatGender(pokemon.gender);const nature=pokemon.nature||"???";const ability=pokemon.ability||"???";const isLead=pokemon.isLead===true;const leadTag=isLead?" [🎯领队]":"";const filledStatsMeta=autoFillStatsMeta(pokemon);const ivs=filledStatsMeta.ivs;const evLevel=filledStatsMeta.ev_level;const ivsDisplay=formatIVsDisplay(ivs);const bonds=pokemon.bonds||0;const bondsDisplay=bonds>0?`${bonds}`:"0";const moves=Array.isArray(pokemon.moves)&&pokemon.moves.length>0?pokemon.moves:[];const movesCount=moves.length;const movesDetailed=Array.from({length:4}).map((_,moveIdx)=>{const moveName=moves[moveIdx]||"—";return`move${moveIdx+1}: ${moveName}`}).join(" | ");return`slot${slotNum}. ${gender} ${name} (Lv.${level})${leadTag}\n   🧬 [Nature: ${nature}] [Ability: ${ability}]\n   💎 [Stats: ${ivsDisplay}] [EVs: ${evLevel}] [Bonds: ${bondsDisplay}]\n   ⚔️ Moves (${movesCount}/4): ${movesDetailed}`}).join("\n\n");const unlocksDisplay=[];if(unlocks.enable_mega)unlocksDisplay.push("Mega");if(unlocks.enable_z_move)unlocksDisplay.push("Z");if(unlocks.enable_dynamax)unlocksDisplay.push("Dmax");if(unlocks.enable_tera)unlocksDisplay.push("Tera");if(unlocks.enable_bond)unlocksDisplay.push("Bond");if(unlocks.enable_styles)unlocksDisplay.push("Style");if(unlocks.enable_insight)unlocksDisplay.push("Insight");if(unlocks.enable_proficiency_cap)unlocksDisplay.push("ProfCap");const unlocksStr=unlocksDisplay.length>0?unlocksDisplay.join("/"):"无";let inventorySection="";if(unlocksDisplay.length>0){inventorySection=`\n🔓 《解锁能力》\n  ${unlocksDisplay.join(" | ")}\n`}let boxSection="";const boxData=playerData?.box||{};const boxPokemon=Object.entries(boxData).filter(([key,pokemon])=>pokemon&&pokemon.name).map(([key,pokemon])=>{const name=pokemon.nickname||pokemon.name;const level=pokemon.lv||pokemon.level||"??";return`${name}/Lv.${level}`});if(boxPokemon.length>0){boxSection=`\n📦 《BOX 存储》(${boxPokemon.length})\n  ${boxPokemon.join(" | ")}\n`}return`<pkm_team_summary>\n【当前玩家状态】\n👤 训练家: ${playerName} | 🔓 解锁: [${unlocksStr}] | 🎒 队伍: (${partyCount}/6)\n--------------------------------------------------\n${partyLines}\n--------------------------------------------------\n${inventorySection}${boxSection}\n--------------------------------------------------\n💡 提示: 战斗中请通过 <PKM_BATTLE> 标签调用队伍。\n</pkm_team_summary>`}async function handleGenerationBeforeInject(detail){const isDryRun=Boolean(detail&&detail.dryRun);try{try{uninjectPrompts([PKM_INJECT_ID])}catch(e){}const playerData=await getPlayerParty();console.log(`${PLUGIN_NAME} [DEBUG] 原始 playerData:`,JSON.stringify(playerData,null,2));const evUpdateData={};if(playerData&&playerData.party){for(const[slotKey,slotData]of Object.entries(playerData.party)){if(slotData&&slotData.stats_meta&&slotData.stats_meta.ev_up>0){const currentEvLevel=slotData.stats_meta.ev_level||0;const evUp=slotData.stats_meta.ev_up;let newEvLevel;let mode;if(evUp>currentEvLevel&&currentEvLevel>=20){newEvLevel=evUp;mode="替换（AI 误输出总值）"}else{newEvLevel=currentEvLevel+evUp;mode="累加"}console.log(`${PLUGIN_NAME} [EV_UP] 槽位: ${slotKey}, 当前 ev_level: ${currentEvLevel}, ev_up: ${evUp}, 新 ev_level: ${newEvLevel}, 模式: ${mode}`);evUpdateData[`pkm.player.party.${slotKey}.stats_meta.ev_level`]=newEvLevel;evUpdateData[`pkm.player.party.${slotKey}.stats_meta.ev_up`]=0;slotData.stats_meta.ev_level=newEvLevel;slotData.stats_meta.ev_up=0}}}if(Object.keys(evUpdateData).length>0){try{await updateEraVars(evUpdateData);console.log(`${PLUGIN_NAME} ✓ 已处理 ev_up 并更新到 ERA`)}catch(e){console.warn(`${PLUGIN_NAME} 更新 ev_up 失败:`,e)}}const bondsUpdateData={};if(playerData&&playerData.party){for(const[slotKey,slotData]of Object.entries(playerData.party)){if(slotData&&typeof slotData.bonds_up==="number"&&slotData.bonds_up>0){const currentBonds=slotData.bonds||0;const bondsUp=slotData.bonds_up;const newBonds=currentBonds+bondsUp;console.log(`${PLUGIN_NAME} [BONDS_UP] 槽位: ${slotKey}, 当前 bonds: ${currentBonds}, bonds_up: ${bondsUp}, 新 bonds: ${newBonds}`);bondsUpdateData[`pkm.player.party.${slotKey}.bonds`]=newBonds;bondsUpdateData[`pkm.player.party.${slotKey}.bonds_up`]=0;slotData.bonds=newBonds;slotData.bonds_up=0}}}if(Object.keys(bondsUpdateData).length>0){try{await updateEraVars(bondsUpdateData);console.log(`${PLUGIN_NAME} ✓ 已处理 bonds_up 并更新到 ERA`)}catch(e){console.warn(`${PLUGIN_NAME} 更新 bonds_up 失败:`,e)}}const proficiencyUpdateData={};if(playerData){const currentProficiency=playerData.trainerProficiency||0;const proficiencyUp=playerData.proficiency_up||0;if(proficiencyUp!==0){const newProficiency=Math.max(0,Math.min(255,currentProficiency+proficiencyUp));console.log(`${PLUGIN_NAME} [PROFICIENCY] 当前: ${currentProficiency}, +${proficiencyUp} = ${newProficiency}`);proficiencyUpdateData["player.trainerProficiency"]=newProficiency;proficiencyUpdateData["player.proficiency_up"]=0;playerData.trainerProficiency=newProficiency;playerData.proficiency_up=0}}if(Object.keys(proficiencyUpdateData).length>0){try{await updateEraVars(proficiencyUpdateData);console.log(`${PLUGIN_NAME} ✓ 已处理 proficiency_up 并更新到 ERA`)}catch(e){console.warn(`${PLUGIN_NAME} 更新 proficiency_up 失败:`,e)}}const aceUpdateData={};let pokemonCount=0;if(playerData&&playerData.party){for(const[slotKey,slotData]of Object.entries(playerData.party)){if(!slotData||!slotData.name)continue;pokemonCount++;if(!slotData.isAce){slotData.isAce=true;aceUpdateData[`pkm.player.party.${slotKey}.isAce`]=true}}}if(Object.keys(aceUpdateData).length>0){try{await updateEraVars(aceUpdateData);console.log(`${PLUGIN_NAME} ✓ 已设置 ${Object.keys(aceUpdateData).length} 只玩家宝可梦 isAce`)}catch(e){console.warn(`${PLUGIN_NAME} 更新 isAce 失败:`,e)}}else if(pokemonCount===0){console.log(`${PLUGIN_NAME} [DEBUG] 队伍中没有宝可梦，跳过 isAce 设置`)}const parsedParty=parsePartyData(playerData?.party);if(!playerData||parsedParty.length===0){console.log(`${PLUGIN_NAME} 玩家队伍为空，跳过注入`);return}console.log(`${PLUGIN_NAME} [DEBUG] 解析后 parsedParty:`,JSON.stringify(parsedParty,null,2));const slotsToUpdate={};const displayParty=parsedParty.map(p=>{const statsMeta=p.stats_meta||{};const hasValidIVs=isValidIVs(statsMeta.ivs);const hasEVLevel=statsMeta.ev_level!==undefined&&statsMeta.ev_level!==null;if(!hasValidIVs||!hasEVLevel){const filled=autoFillStatsMeta(p);const slotKey=`slot${p.slot||1}`;slotsToUpdate[slotKey]={stats_meta:filled};console.log(`${PLUGIN_NAME} [IVs] 为 ${p.name} (${slotKey}) 生成 stats_meta，将持久化`);return{...p,stats_meta:filled}}return p});if(Object.keys(slotsToUpdate).length>0){try{const updateData={};for(const[slotKey,data]of Object.entries(slotsToUpdate)){updateData[`pkm.player.party.${slotKey}.stats_meta`]=data.stats_meta}await updateEraVars(updateData);console.log(`${PLUGIN_NAME} ✓ 已持久化 ${Object.keys(slotsToUpdate).length} 个槽位的 stats_meta`)}catch(e){console.warn(`${PLUGIN_NAME} 持久化 stats_meta 失败:`,e)}}const displayPlayerData={...playerData,party:displayParty};const promptContent=generatePlayerDataPrompt(displayPlayerData);if(!promptContent)return;injectPrompts([{id:PKM_INJECT_ID,position:"in_chat",depth:2,role:"system",should_scan:false,content:promptContent}]);console.log(`${PLUGIN_NAME} ✓ 玩家队伍数据已注入到上下文`)}catch(e){console.error(`${PLUGIN_NAME} 注入失败:`,e)}}async function handleWriteDone(detail){if(isProcessing){console.log(`${PLUGIN_NAME} 正在处理中，跳过`);return}const messageId=detail?.message_id??getLastMessageId();try{isProcessing=true;const messages=getChatMessages(messageId);if(!messages||messages.length===0){isProcessing=false;return}const msg=messages[0];const content=msg.message||"";if(!content.includes(`<${PKM_BATTLE_TAG}>`)){isProcessing=false;return}if(content.includes("<PKM_FRONTEND>")){console.log(`${PLUGIN_NAME} 已处理过，跳过`);isProcessing=false;return}console.log(`${PLUGIN_NAME} 检测到战斗标签，开始处理...`);const aiBattleData=parseAiBattleOutput(content);if(!aiBattleData){console.warn(`${PLUGIN_NAME} 无法解析战斗数据`);isProcessing=false;return}const completeBattle=await buildCompleteBattleJson(aiBattleData);await injectBattleFrontend(messageId,completeBattle);isProcessing=false}catch(e){console.error(`${PLUGIN_NAME} 处理消息失败:`,e);isProcessing=false}}let retries=0;while(typeof eventEmit==="undefined"&&retries<30){await wait(100);retries++}if(typeof eventEmit==="undefined"){console.error(`${PLUGIN_NAME} 酒馆助手API不可用，插件无法启动`);return}eventOn("CHAT_CHANGED",()=>resetState("切换对话"));eventOn("tavern_events.MESSAGE_SWIPED",()=>resetState("消息重骰"));eventOn("tavern_events.MESSAGE_EDITED",()=>resetState("消息编辑"));eventOn("GENERATION_AFTER_COMMANDS",async detail=>{await handleGenerationBeforeInject(detail)});eventOn("era:writeDone",async detail=>{await handleWriteDone(detail)});window.PKMPlugin={getPlayerParty:getPlayerParty,setPlayerParty:setPlayerParty,async addToParty(pokemon){const playerData=await getPlayerParty()||{name:"训练家",party:[],reserve:[]};const newParty=[...playerData.party,pokemon];return setPlayerParty("custom",newParty)},async addToReserve(pokemon){const eraVars=await getEraVars();const playerData=getEraValue(eraVars,"player",{name:"训练家",party:[],reserve:[]});const newReserve=[...playerData.reserve||[],pokemon];updateEraVars({player:{...playerData,reserve:newReserve}});console.log(`${PLUGIN_NAME} ✓ 宝可梦已添加到备用库:`,pokemon);return newReserve},async setPlayerName(name){const eraVars=await getEraVars();const playerData=getEraValue(eraVars,"player",{name:"训练家",party:[],reserve:[]});updateEraVars({player:{...playerData,name:name}});console.log(`${PLUGIN_NAME} ✓ 玩家名称已设置为: ${name}`)},async triggerBattle(aiBattleData){const completeBattle=await buildCompleteBattleJson(aiBattleData);const frontendPayload=`<PKM_FRONTEND>\n${JSON.stringify(completeBattle)}\n</PKM_FRONTEND>`;await createChatMessages([{role:"assistant",message:frontendPayload}]);return completeBattle},version:"2.0.0-mini"};async function preprocessEraUpdate(updateData){if(!updateData||typeof updateData!=="object")return updateData;const currentVars=await getEraVars();function processObject(obj,path=""){if(!obj||typeof obj!=="object")return obj;if(path==="player"||path==="pkm.player"||path.endsWith(".player")){const proficiencyUp=obj.proficiency_up;if(proficiencyUp!==undefined&&proficiencyUp!==null&&typeof proficiencyUp==="number"&&proficiencyUp!==0){const currentProficiency=getEraValue(currentVars,"player.trainerProficiency",0);const newProficiency=Math.max(0,Math.min(255,currentProficiency+proficiencyUp));console.log(`${PLUGIN_NAME} [PROFICIENCY] 当前: ${currentProficiency}, +${proficiencyUp} = ${newProficiency}`);obj.trainerProficiency=newProficiency;obj.proficiency_up=0}}if((path.includes("player.party.slot")||path.includes("pkm.player.party.slot"))&&obj.stats_meta&&typeof obj.stats_meta==="object"){const slotMatch=path.match(/slot\d+/);if(slotMatch){const slotKey=slotMatch[0];const evUp=obj.stats_meta.ev_up;if(evUp!==undefined&&evUp!==null&&typeof evUp==="number"&&evUp>0){const currentEvLevel=getEraValue(currentVars,`player.party.${slotKey}.stats_meta.ev_level`,0);const newEvLevel=currentEvLevel+evUp;console.log(`${PLUGIN_NAME} [EV_UP] 槽位: ${slotKey}, 当前 ev_level: ${currentEvLevel}, ev_up: ${evUp}, 新 ev_level: ${newEvLevel}`);obj.stats_meta.ev_level=newEvLevel;obj.stats_meta.ev_up=0}}}if(path.includes("player.party.slot")||path.includes("pkm.player.party.slot")){const slotMatch=path.match(/slot\d+/);if(slotMatch){const slotKey=slotMatch[0];const bondsUp=obj.bonds_up;if(bondsUp!==undefined&&bondsUp!==null&&typeof bondsUp==="number"&&bondsUp>0){const currentBonds=getEraValue(currentVars,`player.party.${slotKey}.bonds`,0);const newBonds=currentBonds+bondsUp;console.log(`${PLUGIN_NAME} [BONDS_UP] 槽位: ${slotKey}, 当前 bonds: ${currentBonds}, bonds_up: ${bondsUp}, 新 bonds: ${newBonds}`);obj.bonds=newBonds;obj.bonds_up=0}}}for(const[key,value]of Object.entries(obj)){if(value&&typeof value==="object"&&!Array.isArray(value)){const newPath=path?`${path}.${key}`:key;processObject(value,newPath)}}return obj}return processObject(updateData)}const originalEventEmit=window.eventEmit;if(originalEventEmit){window.eventEmit=function(eventName,data){if(eventName==="era:updateByObject"&&data){console.log(`${PLUGIN_NAME} [拦截] 检测到 ERA 变量更新事件`);preprocessEraUpdate(data).then(processedData=>{originalEventEmit.call(window,eventName,processedData)})}else{originalEventEmit.apply(window,arguments)}};console.log(`${PLUGIN_NAME} ✓ ERA 变量更新拦截器已安装（ev_up/proficiency_up 自动累加模式）`)}console.log(`${PLUGIN_NAME} ✓✓✓ Mini版本插件加载完成 (v2.0.0) ✓✓✓`);console.log(`${PLUGIN_NAME} 可用接口: window.PKMPlugin`);console.log(`${PLUGIN_NAME} [队伍] getPlayerParty() / setPlayerParty(mode, input) / addToParty(pokemon)`);console.log(`${PLUGIN_NAME} [战斗] triggerBattle(data)`)})();